trigger:
  branches:
    include:
      - main
      - feature/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  pythonVersion: '3.11'
  projectRoot: '.'

stages:

# -----------------------------
# 1. TEST STAGE
# -----------------------------

- stage: Test
  displayName: "Run Django Tests"
  jobs:
  - job: RunTests
    displayName: "Install dependencies and execute tests"
    steps:

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'

    - script: |
        python -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
        python manage.py collectstatic --noinput
        python manage.py test
      displayName: "Run Django tests"

    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/TEST-*.xml'
        failTaskOnFailedTests: false
      condition: succeededOrFailed()
      displayName: "Publish test results"

# -----------------------------
# 2. BUILD STAGE
# -----------------------------

- stage: Build
  displayName: "Build Artifact"
  dependsOn: Test
  condition: succeeded()
  jobs:
  - job: BuildArtifact
    displayName: "Archive project"
    steps:

    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: '$(projectRoot)'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/relecloud.zip'

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)/relecloud.zip'
        artifactName: 'drop'
      displayName: "Publish build artifact"

# -----------------------------
# 3. DEPLOY STAGE
# -----------------------------

- stage: Deploy
  displayName: "Deploy to Azure Web App"
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DeployWebApp
    displayName: "Deploy to Azure App Service"
    steps:

    # Autenticaci√≥n con el servicio Azure
    - task: AzureWebApp@1
      inputs:
        azureSubscription: 'azure-relecloud-connection'
        appType: 'webAppLinux'
        appName: '$(AZURE_WEBAPP_NAME)'
        package: '$(Pipeline.Workspace)/drop/relecloud.zip'
      displayName: "Deploy to Azure App Service"
