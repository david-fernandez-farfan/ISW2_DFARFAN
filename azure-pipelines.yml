trigger:
  branches:
    include:
      - main      # Ejecutar pipeline cuando haya cambios en main

pool:
  vmImage: "ubuntu-latest"

variables:
  pythonVersion: "3.13"

steps:
# ---------------------------
# 1) Configurar Python
# ---------------------------
- task: UsePythonVersion@0
  inputs:
    versionSpec: "$(pythonVersion)"
  displayName: "Configurar Python $(pythonVersion)"

# ---------------------------
# 2) Instalar dependencias
# ---------------------------
- script: |
    python -m pip install --upgrade pip
    pip install -r requirements.txt
  displayName: "Instalar dependencias del proyecto"

# ---------------------------
# 3) Ejecutar tests (opcional pero recomendado)
# ---------------------------
#- script: |
#    python manage.py test
#  displayName: "Ejecutar tests"
#  continueOnError: true   # Evita que falle la pipeline si no tienes tests a√∫n

# ---------------------------
# 4) Collectstatic para Django
# ---------------------------
- script: |
    python manage.py collectstatic --noinput
  displayName: "Generar staticfiles"

# ---------------------------
# 5) Publicar artefactos para deploy
# ---------------------------
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: "$(System.DefaultWorkingDirectory)"
    ArtifactName: "drop"
  displayName: "Publicar artefactos"

# ---------------------------
# 6) Deploy a Azure Web App
# ---------------------------
- task: AzureWebApp@1
  displayName: "Desplegar a Azure App Service"
  inputs:
    azureSubscription: "azureISW2_DFARFAN"
    appName: "DavidFFDjango"
    package: "$(System.DefaultWorkingDirectory)"
